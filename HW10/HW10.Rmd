---
title: "HW10：Practicing SQL Queries"
author: "YI YIN"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path="images/",
                      cache.path="cache/",
                      cache=TRUE,
                      message=FALSE,
                      warning=FALSE)

```

```{r}

library(DBI)
# Connection

witch_con <- dbConnect(RMySQL::MySQL(),
                 user='student', 
                 password='mds-is-fun',
                 dbname='witchcraft', 
                 host='tbrambor.cczjcoy6i2jn.us-east-1.rds.amazonaws.com',
                 port = 3306)


```

# 1. Getting to know the data
a. Show a list of the tables included in the database.

```{sql, connection = "witch_con"}
SHOW TABLES
```


b. Display the column names for the table accused.
```{sql, connection = "witch_con"}
DESCRIBE accused
```
c.How many people are included in the accused table?
```{sql, connection = "witch_con"}
SELECT COUNT(*) AS 'NUMBER OF PEOPLE'
FROM accused
```


d. Display the columns firstname, sex, and age for 5 cases in the accused table.
```{sql, connection = "witch_con"}
SELECT firstname, sex, age 
FROM accused
LIMIT 5
```


e.Looks like the age is missing for some observations. Count the number of nonmissing values for age in the data.

```{sql, connection = "witch_con"}
SELECT COUNT(*)
FROM accused
WHERE age IS NOT NULL
```

f.Show a list of unique occupations.
```{sql, connection = "witch_con"}
SELECT DISTINCT(OCCUPATION)
FROM accused
```


# 2. Seeing the Devil
Let’s look at some appearances of the devil in the devilappearance table.


a.List the unique devil_types in the data.
```{sql, connection = "witch_con"}
SELECT DISTINCT(devil_type)
FROM devilappearance
```


b.There is also a little description of the type of the devil sighting in the devil_text column. How many of the sightings mention the word “black” in the description?
```{sql, connection = "witch_con"}
SELECT COUNT(devil_text) AS 'Number of description with "black"'
FROM devilappearance
WHERE devil_text LIKE "%black%"
```

c.What proportion of the devils (in devil_type) are male?
```{sql, connection = "witch_con"}
SELECT devil_type, 
ROUND(COUNT(*)* 100./(SELECT COUNT(devil_type) FROM devilappearance), 2) AS 'Proportion (%)'
FROM devilappearance
WHERE devil_type LIKE 'MALE'
GROUP BY devil_type



```

# 3. The trial


a.What are the average and maximum numbers of male and female accusers?
```{sql, connection = "witch_con"}
SELECT AVG(female_accusers) AS 'Avg of female accusers',
AVG(male_accusers) AS 'Avg of male accusers',
MAX(female_accusers) AS 'Max of female accusers',
MAX(male_accusers) AS 'Max of male accusers'
FROM trial
```


b.Count the number of sentences by sentence type. 
List them in a table (in descending order), excluding missing values. Rename the column headings to something sensible.
```{sql, connection = "witch_con"}
SELECT sentence, COUNT(*) AS number
FROM trial 
WHERE sentence IS NOT NULL
GROUP BY sentence
ORDER BY number DESC
```


c.Do the number of accusers matter for the verdict? 

Compare the average number of accusers by the type of verdict. 
Again make sure the table is sorted and the headings make sense.

```{sql, connection = "witch_con"}
SELECT verdict, ROUND(female_accusers+male_accusers/count(*),2) AS 'average number of accusers'
FROM trial
WHERE verdict IS NOT NULL
GROUP BY verdict
ORDER BY female_accusers+male_accusers/count(*) DESC
```


# 4. Tortured Truth (Bonus)

Left join the trial and confession tables. For what share of trials does the database record confessions? Create a results table with the number of all trials, the number of confessions, and the share of trials with confessions recorded.




```{sql, connection = "witch_con"}
SELECT COUNT(trial.trialref) AS 'number of all trials',
COUNT(confession.confessionref) AS 'the number of confessions',
ROUND(COUNT(confession.trialref)/COUNT(trial.trialref),2) AS 'the share trials with confessions recorded'
FROM trial
LEFT JOIN confession
ON trial.trialref = confession.trialref
```





Only a small number of trials have records of torture.

There is a higher share of confessions among trials with records of torture than trials without such record
```{sql, connection = "witch_con"}
SELECT 
ROUND(COUNT(confession.trialref)/COUNT(trial.trialref),2) AS 'without torture'
FROM trial 
LEFT JOIN confession
ON trial.trialref = confession.trialref
WHERE trial.trialref NOT IN (
SELECT trialref
FROM torture)
```


```{sql, connection = "witch_con"}

SELECT ROUND(COUNT(confession.trialref)/COUNT(torture.trialref),2) AS 'confessions among trials with torture'
FROM torture
LEFT JOIN confession
ON confession.trialref = torture.trialref

````
