---
title: 'HW02: Data Wrangling'
author: "YIN YI"
date: "10/01/2018"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path="images/",
                      cache.path="cache/",
                      cache=TRUE,
                      message=FALSE,
                      warning=FALSE)

```

## Selection of Data and Tidying
Save the cleaned dataset as `binge_clean.csv`. That file is included in the uploaded files for homework submission.

```{r, cache=TRUE, eval=FALSE, echo=FALSE, results='hide'}
cdi <- readr::read_csv("U.S._Chronic_Disease_Indicators__CDI_.csv")
# 1. Remove all columns you do not need for the analysis 
# 2. We are interested in two sets of variables. 
# Select the following variables and remove all others:
cdi_rm <- cdi%>%dplyr::select(YearStart,
                              YearEnd,
                              LocationAbbr,
                              LocationDesc,
                              Question,
                              DataValue,
                              DataValueType,
                              Stratification1)%>%
        dplyr::filter(Question %in% 
                              c('Binge drinking prevalence among adults aged >= 18 years', 'Poverty') 
                      & DataValueType == 'Crude Prevalence')%>%dplyr::select(-DataValueType)


cdi_rm <- cdi_rm%>%dplyr::filter(Stratification1 %in% c('Overall', 'Male', 'Female' ))
                              
#3. Convert the dataset to a tidy data set using the commands from the tidyr package.

cdi_tidy <- cdi_rm%>% unite(category, Question, Stratification1) %>%
        spread(key = category, value = DataValue)

head(cdi_tidy)

# 4. Rename the variables to follow the format below.
cdi_tidy <- cdi_tidy%>%dplyr::select(-YearStart, -Poverty_Female, -Poverty_Male)%>%
        dplyr::rename(state = LocationDesc,
                      stateabb = LocationAbbr,
                      year = YearEnd,
        binge_all = `Binge drinking prevalence among adults aged >= 18 years_Overall`,
        binge_male = `Binge drinking prevalence among adults aged >= 18 years_Male`,
        binge_female = `Binge drinking prevalence among adults aged >= 18 years_Female`,
        poverty = Poverty_Overall)

# Save the cleaned dataset as binge_clean.csv
write.csv(cdi_tidy, "binge_clean.csv")
```


## Data Transformation and Summary Results
### 5. Produce a table that shows the overall, female, and male binge drinking prevalences across U.S. States in the most recent year of data for the Top 10 binge drinking states (i.e. the ones with the highest prevalence in the overall population). Use the relevant dplyr commands to  select the right variables, sort the data (arrange()), and filter the data frame.
```{r, cache=TRUE, message=FALSE}
library(tidyverse)
cdi_tidy <- read_csv('binge_clean.csv')
cdi_tidy%>%dplyr::filter(year == 2016 )%>%
        arrange(desc(binge_all))%>%
        dplyr::select(state, binge_all,binge_female,binge_male)%>%
        top_n(10,binge_all)
```

### 6. Make a simple scatter plot showing the correlation between the overall poverty prevalence in a state and the prevalence of binge drinking in the overall population. I suggest to use ggplot. Add a loess smoothed fit curve (use geom_smooth in the ggplot2 package) to indicate the pattern. Comment briefly.

```{r, cache=TRUE, message=FALSE}
cdi_tidy%>%ggplot(aes(x= binge_all, y = poverty, 
                      label = stateabb )) +
        geom_point(size = 0.5) + 
        geom_text(check_overlap = TRUE, hjust = -0.05, nudge_x = 0.05)+
        geom_smooth(size = 0.8, colour = '#4EB6D4')+
        geom_smooth(method='lm', formula =  y ~ x, 
                    se = FALSE, colour = '#D69CBE', linetype = 2)+
        ggtitle("Overall Poverty Prevalence VS. Prevalence of Binge Drinking")+
        xlab("prevalence of binge drinking")+
        ylab("overall poverty prevalence")+
        scale_x_continuous(labels = function(x) paste0(x, "%"))+
        scale_y_continuous(labels = function(y) paste0(y, "%"))+
        theme_bw(base_size = 11, base_family = "Palatino")+
        theme(plot.title = element_text(hjust = 0.5))


```

*Comment*: Overall, there is a slight negative association between the overall poverty prevalence in a state and the prevalence of binge drinking in the overall population. However, the variance in poverty prevalence of extrem high and low binge drinking state are larger than the variance in poverty prevalence of medium binge drinking state.

```{r}
model <- lm( poverty ~ binge_all , data = cdi_tidy)
library(olsrr)
olsrr::ols_test_breusch_pagan(model)

```

By the Breush-Pagan test we can see the heteroscedasticity in `poverty ~ binge_all` model. Therefore, it is hard to draw inference from a simple linear model between this two variable.


### 7.Calculate the average annual growth rates (in percent) of overall binge drinking across states for the years the data is available.

One way to get these growth rates, is to group the data by state (dplry::group_by) and use the first() and last() commands in the  summarize command followed by dividing the calculated percentage increase by the number of years. 

Provide a table of the 5 states with the largest increases and the 5 states with the largest decreases in binge drinking prevalence over the time period.

```{r}

largest_increases <- cdi_tidy%>%select(state, year, binge_all)%>%
        dplyr::group_by(state)%>%
        dplyr::filter(is.na(binge_all) == FALSE, 
                      state != "United States")%>%
        summarise(avg_growth = (last(x = binge_all, order_by = year) -
                                first(x = binge_all, order_by = year)
                                )/length(unique(year)))%>%
        arrange(desc(avg_growth))%>%
        slice(1:5)


largest_decreases <- cdi_tidy%>%select(state, year, binge_all)%>%
        dplyr::group_by(state)%>%
        dplyr::filter(is.na(binge_all) == FALSE, 
                      state != "United States")%>%
        summarise(avg_growth = (last(x = binge_all, order_by = year) -
                                first(x = binge_all, order_by = year)
                                )/length(unique(year)))%>%
        arrange(avg_growth)%>%
        slice(1:5)

dplyr::union(largest_increases,largest_decreases)%>%
        arrange(desc(avg_growth))
        
        
   

        

```

