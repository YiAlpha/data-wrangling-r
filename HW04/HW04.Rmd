---
title: "HW04：Functions II"
author: "YI YIN"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path="images/",
                      cache.path="cache/",
                      cache=TRUE,
                      message=FALSE,
                      warning=FALSE)

```

# 1. Functions in the R Base Package
```{r, echo=FALSE}
content <- mget(ls("package:base"), inherits = TRUE)
base_functions <- Filter(is.function, content)
rm(content)
library(purrr)
library(dplyr)
```

## a) Longest name
Use the appropriate map function to produce a vector of the names of all functions in the base R package. 
```{r}
fun_names <- names(base_functions)
```

Which function has the longest name?

**-- `getDLLRegisteredRoutines.character` has the longest name**

```{r}
name_length <- map_dbl(fun_names, nchar)

data.frame(fun_names, name_length)%>%
        filter(name_length == max(name_length))%>%
        select(fun_names)

```

## b) Number of arguments
Use the appropriate map function to calculate the number of arguments by function. Present a table of the Top 10 functions with the most arguments.
```{r}
num_arg <- pmap_dbl(list(1:length(base_functions)),
                ~length(formals(base_functions[[.]])))

data.frame(fun_names, num_arg)%>%
        top_n(10,num_arg)%>%
        arrange(desc(num_arg))
```

Which base function has the most arguments? 

**-- `scan` has the most arguments.**

## c) No arguments
How many base functions have no arguments? What do you think is different about them?

```{r}
data.frame(fun_names, num_arg)%>%
        filter(num_arg == 0)%>%nrow()
```

**-- 224 base functions have no arguments.**

# 2. Infant Mortality and GPD per Capita

## a) Highest and lowest infant mortality rates in 2017

Make sure to obtain information about the region of the country as well (using the extra=TRUE option in the WDI() command). Specify the requested range of years from 1960 to 2017.

Rename the variables: infant mortality (infmort) and GPD per

```{r}
library(WDI)
wdi <- WDI(country = "all", 
    indicator = c("NY.GDP.PCAP.PP.KD", "SP.DYN.IMRT.IN"), 
    start = 1960,
    end = 2017, 
    extra=TRUE)

dat<-wdi%>%dplyr::rename(gdpcap = NY.GDP.PCAP.PP.KD,
                    infmort = SP.DYN.IMRT.IN)%>%
        dplyr::filter(longitude != "", latitude != "")



```

Present a list of countries with the 5 highest and the 5 lowest infant mortality rates in 2017 along with their GDP per capita in that year.

```{r}
# 5 highest
dat%>%filter(year == 2017)%>%
        arrange(desc(infmort))%>%
        filter(between(row_number(), 1, 5))%>%
        select(country, infmort, gdpcap)%>%
        # and 5 lowest
        dplyr::full_join(dat%>%filter(year == 2017)%>%
        arrange(infmort)%>%
        filter(between(row_number(), 1, 5))%>%
        select(country, infmort, gdpcap))


```


b) Overall regression
Run an overall regression predicting infant mortality from GDP per capita. What do you find? 

-- I find a significant negetive association between infant mortality and GDP per capita
```{r}
summary(lm(infmort ~ gdpcap, data = dat))$coefficients
```


Make a scatter plot (including a regression fit line).
```{r}
library(ggplot2)
dat%>%select(infmort, gdpcap)%>%
       ggplot(aes(gdpcap, infmort))+
        geom_point()+
        geom_smooth(method = lm, se = FALSE)+
        ggtitle('Infant mortality by GDP per capita')+
        theme_bw(base_size = 11, base_family = "Palatino")+
        theme(plot.title = element_text(hjust = 0.5))
        
```

c) Regression by region
Let’s see if the overall relationship holds within world regions. 
Split the the data by region and create a nested list that contains these split data frames.
In a single pipeline, re-estimate the regression for each of these data frames, obtain the coefficient estimates for the slope for each region and present them in a table (sorted by size of the coefficient).


```{r}
dat%>%split(dat$region)%>%
        map(possibly(~ lm(infmort ~ gdpcap, data = .), 
                     otherwise = NA_real_))%>%
        discard(is.na(.) == T) %>%
        map(~ coef(.))%>%
        map_dbl("gdpcap") %>% 
        tibble(region = attr(., "names"), 
               coef = .)%>%
        arrange(coef)
```




d) Regression by country
Let’s also check if the relationship is consistent if estimated within countries. Split the overall data by country and create a nested list that contains these split data frames. Again, estimate a simple linear regression, predicting infant mortality by GDP per capita. 


In what percentage of the within-country regressions do we find a positive relationship (at the 95% confidence level) between GDP per capita and infant mortality? 


```{r}
# extract slope p-value for 95% confidence level
pvalue <- dat%>%split(dat$country)%>%
        map(possibly(~ lm(infmort ~ gdpcap, data = .),
                     otherwise = NA_real_))%>%
        discard(is.na(.) == T) %>%
        map(summary)%>%map_dbl(possibly(
                        ~ .$coefficients['gdpcap', 'Pr(>|t|)'],
                         otherwise = NA_real_)) 
```


**-- We find 6.06% the within-country regressions have a positive relationship (at the 95% confidence level) between GDP per capita and infant mortality**

```{r}
dat%>%split(dat$country)%>%
        map(possibly(~ lm(infmort ~ gdpcap, data = .),
                     otherwise = NA_real_))%>%
        discard(is.na(.) == T) %>%
        map(summary)%>%map_dbl(possibly(
                        ~ .$coefficients['gdpcap', 'Estimate'],
                         otherwise = NA_real_))%>%
        tibble(country = attr(., "names"), 
                  coef = .)%>%cbind(pvalue)%>%
        filter(pvalue < 0.05)%>%
        mutate(pos_slope = ifelse(coef >0, T, F))%>%
        group_by(pos_slope)%>%summarise(n = n())%>%
        mutate(percent = n/sum(n)* 100)

```


Make a histogram of the slope coefficients to illustrate the variation of the estimated relationship. 

```{r}
dat%>%split(dat$country)%>%
        map(safely(~ lm(infmort ~ gdpcap, data = .)))%>%
        transpose()%>%pluck("result")%>%discard(is.null)%>%
        map(~ coef(.))%>%
        map_dbl("gdpcap")%>%hist(breaks = 100,
                                 col = "#53B2D6",
                                 border = '#53B2D6',
                                 xlab = "Coefficients", 
                                 main = "Histogram of Slope Coefficients")

```


Which country cases are most at odds with the overall regression estimated in part (b)?

-- overall regression estimated in part (b) is -0.0009353066.

-- **With regard to the absolute value difference, `Malawi` are most at odds with the overall regression estimated.**



```{r}
dat%>%split(dat$country)%>%
        map(possibly(~ lm(infmort ~ gdpcap, data = .),
                     otherwise = NA_real_))%>%
        discard(is.na(.) == T) %>%
        map(summary)%>%
        map_dbl(possibly(
                        ~ .$coefficients['gdpcap', 'Estimate'],
                         otherwise = NA_real_))%>%
        tibble(country = attr(., "names"), 
                  coef = .)%>%cbind(pvalue)%>%
        mutate(diff = abs(coef - (-0.0009353066)))%>%
        arrange(desc(diff))%>%filter(row_number() == 1)
```

-- **With regard to the largest positive slope, `Madagascar` are most at odds with the overall regression estimated.**
```{r}
dat%>%split(dat$country)%>%
        map(possibly(~ lm(infmort ~ gdpcap, data = .),
                     otherwise = NA_real_))%>%
        discard(is.na(.) == T) %>%
        map(summary)%>%map_dbl(possibly(
                        ~ .$coefficients['gdpcap', 'Estimate'],
                         otherwise = NA_real_))%>%
        tibble(country = attr(., "names"), 
                  coef = .)%>%cbind(pvalue)%>%
        arrange(desc(coef))%>%filter(row_number() == 1)

```


e) Added squared term
Let’s see if we can improve the models slightly. Using the list of country data frames from (d), estimate regressions of infant mortality on GDP per capita and the square of GDP per capita. Compare the adjusted R-Squareds of the models with and without the added squared term of GDP per capita. 

Provide the average model adjusted R-squared with and without the squared term. Would you recommend to keep the squared term or not?

**Without the added squared term**
```{r}

dat%>%split(dat$country)%>%
        map(safely(~ lm(infmort ~ gdpcap, data = .)))%>%
        transpose()%>%pluck("result")%>%discard(is.null)%>%
         map(summary) %>% map_dbl("adj.r.squared")%>%mean()

```

**With the added squared term**

**The average model adjusted R-squared with the squared term is 0.08 larger than above**
```{r}

dat%>%split(dat$country)%>%
        map(safely(~ lm(infmort ~ I(gdpcap^2)+ gdpcap, data = .)))%>%
        transpose()%>%pluck("result")%>%discard(is.null)%>%
         map(summary) %>% map_dbl("adj.r.squared")%>%mean()


```

I recommend to keep the squared term since the average model adjusted R-squared with the squared term is larger than the without counterpart.


