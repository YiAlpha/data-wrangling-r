---
title: "HW07：Calling an API using `httr` "
author: "YI YIN"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path="images/",
                      cache.path="cache/",
                      cache=TRUE,
                      message=FALSE,
                      warning=FALSE)

```
## 1. Define the base URL

```{r}
library(httr)
endpoint <- "https://data.lacity.org/resource/7fvc-faax.csv"
```

## 2. Send a simple GET request
Using `httr`, send a simple GET request to the base URL.
```{r}
pageview_response <- GET(endpoint)
```

Status 
```{r}
pageview_response$status_code
```

Structure 
```{r}
str(pageview_response, max.level = 1)
```

## 3. Get the content of the response
Retrieve the content of the response.

```{r}
pageview_data <- content(pageview_response)
```

What are the dimensions of the data frame?
```{r}
dim(pageview_data)
```

Tabulate the areas of the observations included.
```{r}
table(pageview_data$area_name)
```

## 4. Get your access token

```{r}
query_params <- list(
  "$$app_token" = Sys.getenv("LACRIME_APP_TOKEN"),
  "$limit" = "10000"
  )
    
parameter_response <-
  GET(endpoint, 
      query = query_params)
```

```{r}
parameter_response$status_code

token_data <- content(parameter_response)

dim(token_data)
```

### 5. Limiting your query

Query data of Hollywood on 2017 Oct 01.
```{r}
new_params <- list(
  "$$app_token" = Sys.getenv("LACRIME_APP_TOKEN"),
  "$limit" = "10000",
  area_name = 'Hollywood',
  date_occ = '2017-10-01')
    
new_response <-
  GET(endpoint, 
      query = new_params)
```

Providing the server status again
```{r}
new_response$status_code

new_data <- content(new_response)

dim(new_data)


```


### 6. Locations
Write a loop to find the addresses for 50 entries in your dataset based on their latitude and longitude.

```{r}

library(tidyverse)

set.seed(1121)
entries <- sample(token_data$location_1, 50)%>%as_tibble()

latlng <- str_extract(entries$value,"(?<=\\().+?(?=\\))")%>%
        as_tibble()%>%separate(col=value, 
                               into = c("lng", "lat"),
                               sep = "\\s")%>%
        mutate(latlng = paste(lat, lng, sep = ','))%>%.$latlng


urls <-  paste0(
        "https://maps.googleapis.com/maps/api/geocode/json?latlng=",
        latlng, "&", "key=", Sys.getenv("GOOGLE_MAPS_API_KEY"))

                 
for(url in urls){
    # Send a GET request to google
    result <- GET(url)
        if(http_error(result)){
    warning("The request produced an error.")} 
    else {
            }
    # Delay for 0.5 seconds between requests
    Sys.sleep(0.5)
}

```

The object you get back is a bit verbose – aim for the formatted_address part.
```{r}

map_content <- content(result)

address <- purrr::map_chr(1:length(map_content$results),
                          ~map_content$results[[.]]$formatted_address)

address
```


 
 