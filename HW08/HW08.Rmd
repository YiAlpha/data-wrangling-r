---
title: "HW08：Writing a simple API client "
author: "YI YIN"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: architect
    highlight: github
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.path="images/",
                      cache.path="cache/",
                      cache=TRUE,
                      message=FALSE,
                      warning=FALSE)

```


# 1. Choose an API
The Open Movie Database API: 

- a. RESTful web service to obtain movie information, all content and images on the site are contributed and maintained by our users. 

- b. API documentation: http://www.omdbapi.com/

- c. API Endpoint: http://www.omdbapi.com/?

# 2. Authentication
a. API key

b. how: http://www.omdbapi.com/

# 3. Send a Simple GET request



Describe a few query parameters and add them to the query. 

|Parameter|	Required|	Valid Options |  
|--:|--:|--:|
|i |	Optional*	|	A valid IMDb ID (e.g. tt1285016)|
|t |	Optional*|		<empty>	Movie title to search for.|
|type|	No |	movie, series, episode	|
|y|	No	| year of release.|
|plot|	No |	short or full|
|r|	No |	json or  xml|	

a. Execute a simple GET request to obtain a small amount of data from the API. 
```{r}
rm(list=ls())
library(httr) # for working with URLs
library(tidyverse) # for tidying data
```

```{r}
url <- "http://www.omdbapi.com/?"

query_params <- list(
  "apikey" = Sys.getenv("OMDb_KEY"),
  "s" = "Sherlock",
  "plot" = "short",
  "r" = "json"
  )

parameter_response <-
  GET(url, 
      query = query_params)
```

b.Check the status of the request (using http_status).
```{r}
http_status(parameter_response)  
```

c. Check the type of the response (e.g. XML, JSON, csv using http_type).
```{r}
http_type(parameter_response)  
```

4. Parse the response and Create a dataset

a. Take the response returned by the API and turn it into a useful R object (e.g. a list, vector, or data frame). Show the code how this is done.
```{r}
d <- content(parameter_response, as = "parsed", 
             type = "application/json")

data <- dplyr::bind_rows(lapply(d$Search, as.data.frame, stringsAsFactors=FALSE))

head(data)

```


b. Using the API, create a dataset (in data frame format) for multiple records. 

```{r, eval=FALSE}
ids <- paste0(rep("tt0000", 100), 100:200)

urls <-  paste0(
        "http://www.omdbapi.com/?",
        "i=",ids,"&", "apikey=", Sys.getenv("OMDb_KEY"))


for(url in urls){
    # Send a GET request to google
    result <- GET(url)
        if(http_error(result)){
    warning("The request produced an error.")} 
    else {
            }
    # Delay for 0.5 seconds between requests
    Sys.sleep(2)
}

map_content <- content(result)



```

c. Provide some summary statistics of the data. Include the data frame in a .RDS file (using saveRDS) called data.rds with your submission for the grader.


# 5. API Client
Lastly, let’s try to wrap the code from the previous sections into a simple API client function. For example, in the ZillowR package, the command GetSearchResults() can be called with the following command